description "mapreduce-historyserver"

#
# based on instructions from http://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.3.0/bk_installing_manually_book/content/start_mapreduce_jobhistory_server.html
#

start on runlevel [2345]
stop on runlevel [016]

respawn
respawn limit 5 60

kill timeout 300

# actually start history server
pre-start script
  mkdir -p <%= scope['hadoop::mapred_pid_dir'] %>
  chown <%= scope['hadoop::mapreduce_user'] %>:hadoop <%= scope['hadoop::mapred_pid_dir'] %>
  chmod 0755 <%= scope['hadoop::mapred_pid_dir'] %>

  ulimit -n 32768 && sudo -u <%= scope['hadoop::mapreduce_user'] %> /bin/bash /usr/hdp/current/hadoop-mapreduce-historyserver/sbin/mr-jobhistory-daemon.sh --config <%= scope['hadoop::confdir'] %> start historyserver
end script

#
# upstart executes this script. If this script exits, upstart respawns the service
# cannot just excecute *-daemon.sh here, because the actual daemon script excecutes after start
#   and upstart thinks service is stopped so respawns *-daemon.sh constantly.
#
script
  while ps auwx | grep proc_historyserver | grep -q -v grep; do
    sleep 5
  done
end script

post-stop exec sudo -u <%= scope['hadoop::mapreduce_user'] %> /bin/bash /usr/hdp/current/hadoop-mapreduce-historyserver/sbin/mr-jobhistory-daemon.sh --config <%= scope['hadoop::confdir'] %> stop historyserver
